import{G as p,K as I,T as M,M as $,a as B}from"./MNIST-BhAB_iSj.js";const h=20;class S{constructor(t,s,e=24,i=24,a=!1){this.onModelChanged=t,this.onModelCleared=s,this.rows=e,this.columns=i,this.showPadded=a,this.root=document.createElement("div"),document.getElementById("row").appendChild(this.root),this.canvas=document.createElement("canvas"),this.canvas.width=this.columns*h,this.canvas.height=this.rows*h,this.ctx=this.canvas.getContext("2d"),this.model=new Float32Array(e*i),this.outmodel=new Float32Array(784),this.render(this.ctx,this.rows,this.columns,this.model),this.canvas.addEventListener("mousedown",n=>{this.capturing=!0}),this.canvas.addEventListener("mouseup",n=>{this.capturing=!1}),this.canvas.addEventListener("mousemove",n=>{this.capturing&&this.setModel(n.offsetX,n.offsetY,n.altKey)}),this.canvas.addEventListener("click",n=>{this.setModel(n.offsetX,n.offsetY,n.altKey)}),this.canvas.addEventListener("touchstart",n=>{n.preventDefault(),this.capturing=!0;const r=n.touches[0],d=this.canvas.getBoundingClientRect();this.setModel(r.clientX-d.left,r.clientY-d.top,!1)}),this.canvas.addEventListener("touchend",n=>{n.preventDefault(),this.capturing=!1}),this.canvas.addEventListener("touchmove",n=>{if(n.preventDefault(),!this.capturing)return;const r=n.touches[0],d=this.canvas.getBoundingClientRect();this.setModel(r.clientX-d.left,r.clientY-d.top,!1)}),this.root.appendChild(document.createTextNode(`${this.rows}x${this.columns}, padded to 28x28`)),this.root.appendChild(document.createElement("br")),this.root.appendChild(document.createElement("br")),this.root.appendChild(this.canvas),this.root.appendChild(document.createElement("br"));const o=document.createElement("button");o.textContent="Clear",o.addEventListener("click",()=>{this.model.fill(0),this.render(this.ctx,this.rows,this.columns,this.model),this.onModelCleared()}),this.root.appendChild(o),a&&(this.canvasOut=document.createElement("canvas"),this.canvasOut.width=28*h,this.canvasOut.height=28*h,this.ctxOut=this.canvasOut.getContext("2d"),this.root.appendChild(document.createElement("br")),this.root.appendChild(this.canvasOut),this.render(this.ctxOut,28,28,this.outmodel))}root;canvas;ctx;canvasOut;ctxOut;model;outmodel;capturing=!1;incColor(t,s,e=1){s>0&&this.increment(t,s-1,.33*e),s<this.rows-1&&this.increment(t,s+1,.33*e),t>0&&this.increment(t-1,s,.33*e),t<this.columns-1&&this.increment(t+1,s,.33*e),this.increment(t,s,e)}increment(t,s,e){const i=this.model[s*this.columns+t];this.model[s*this.columns+t]=Math.max(0,Math.min(1,i+e))}setModel(t,s,e){const i=Math.floor(t/h),a=Math.floor(s/h);e?this.incColor(i,a,-1):this.incColor(i,a),this.render(this.ctx,this.rows,this.columns,this.model),this.process(),this.showPadded&&this.render(this.ctxOut,28,28,this.outmodel),this.onModelChanged(this.outmodel)}process(){this.outmodel.fill(0);let t=1/0,s=-1/0,e=1/0,i=-1/0;for(let o=0;o<this.rows;o++)for(let n=0;n<this.columns;n++)this.model[o*this.columns+n]>0&&(o<t&&(t=o),o>s&&(s=o),n<e&&(e=n),n>i&&(i=n));const a=Math.floor((28-(i-e))/2),c=Math.floor((28-(s-t))/2);for(let o=0;o<=s-t;o++)for(let n=0;n<=i-e;n++)this.outmodel[(o+c)*28+n+a]=this.model[(o+t)*this.columns+n+e]}render(t,s,e,i){t.fillStyle="#111",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.strokeStyle="white";for(let a=0;a<s;a++)for(let c=0;c<e;c++){const o=i[a*e+c],n=Math.floor(o*255);t.fillStyle=`rgba(${n},${n},${n*.7},1.0)`,t.fillRect(c*h,a*h,h,h),t.strokeRect(c*h,a*h,h,h)}}}class L{ctx;constructor(){const t=document.createElement("canvas");t.width=2*784+20,t.height=280,this.ctx=t.getContext("2d"),this.ctx.font="20px Arial",this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),(document.getElementById("layers")??document.body).appendChild(t)}render(t,s){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),t.forEach((e,i)=>{this.drawLayer(e,10,10+i*65,s[i],i>0)})}drawLayer(t,s,e,i,a=!1){let c=-1/0,o=1/0;for(let r=0;r<t.length;r++)t[r]>c&&(c=t[r]),t[r]<o&&(o=t[r]);for(let r=0;r<t.length;r++)t[r]=(t[r]-o)/(c-o);const n=784/t.length*2;for(let r=0;r<t.length;r++){const d=t[r],u=Math.floor(d*255);this.ctx.fillStyle=`rgb(${u},${u},${u*.8})`,this.ctx.fillRect(s+r*n,e+30,n,20),a&&(this.ctx.strokeStyle="white",this.ctx.strokeRect(s+r*n,e+30,n,20))}this.ctx.fillStyle="White",this.ctx.fillText(i,s,e+20)}}await p.init();const m=new M(p.device),x=new I(p.device,m),f=new $(m,x),T=await f.readSnapshot();k(T);const O=new B;await O.load("data/mnist").catch(l=>{throw new Error("Failed to load data source: "+l)});const P=new Float32Array(10);let y=!1;new S(async l=>{await p.device.queue.onSubmittedWorkDone(),!y&&(y=!0,await R(l),y=!1)},async()=>{b(P),C.render([],[])});const C=new L;(function(){const l=document.getElementById("row"),t=document.createElement("span");t.style.display="inline-flex",t.style.flexDirection="column",t.style.gap="6px";let s=0;Array.from({length:10},()=>{const e=document.createElement("span");e.classList.add("probability"),e.id=`probability-${s}`;const i=document.createElement("input");i.style.pointerEvents="none",i.type="range",i.min="0",i.max="100",i.value="0",i.id=`probability-slider-${s}`,e.appendChild(i),e.appendChild(document.createTextNode(`${s}`));const a=document.createElement("span");return a.id=`probability-percentage-${s}`,e.appendChild(a),t.appendChild(e),s++,i}),l.appendChild(t)})();async function R(l){const t=m.getTensorBuffer("test_input",GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST,[1,l.length],l);m.beginScope("test");const s=f.model.forward(t,!1),e=x.softmax.run(s),i=await m.readBuffer(e.buffer,e.sizeInBytes());b(i);const a=[];for(const o of f.model.layers){const n=o.inputTensor,r=await m.readBuffer(n.buffer,n.sizeInBytes());a.push(r)}a.push(i);const c=f.model.layers.map(o=>`${o.name} [${o.inputTensor?.shape}]`);c.push("Predictions. Shape [1,10]. Digit 0..9"),C.render(a,c)}function b(l){let t=-1/0,s=0;for(let e=0;e<10;e++){const i=l[e];i>t&&(t=i,s=e);const a=document.getElementById(`probability-${e}`);a!==null&&(a.style.backgroundColor="default");const c=document.getElementById(`probability-slider-${e}`);c!==null&&(c.value=(100*i).toFixed(2));const o=(i*100).toFixed(2),n=document.getElementById(`probability-percentage-${e}`);n!==null&&(n.innerHTML=`${o}%`)}for(let e=0;e<10;e++){const i=document.getElementById(`probability-percentage-${e}`);i.style.backgroundColor=e===s&&l[s]>0?"green":"rgba(0,0,0,0)"}}function k(l){v(l[0],768,128,l[1],128,1,"First Layer. Dense [768->128]"),v(l[2],128,10,l[3],10,1,"Output Layer. Dense [128->10]")}function v(l,t,s,e,i,a,c){const o=document.getElementById("parameters-container"),n=document.createElement("div");n.className="parameter-images",o.appendChild(n);const r=document.createElement("h4");r.innerHTML=c,n.appendChild(r),w(n,l,t,s,"Weights"),w(n,e,i,a,"Bias")}function w(l,t,s,e,i){const a=document.createElement("canvas"),c=s<768?10:2;a.width=s*c,a.height=e*c;const o=a.getContext("2d"),n=document.createElement("div");n.className="parameter-image",n.appendChild(document.createTextNode(`${i}`)),n.appendChild(a),l.appendChild(n);const r=D(t);for(let d=0;d<e;d++)for(let u=0;u<s;u++){const E=d*s+u,g=Math.floor(r[E]*255);o.fillStyle=`rgba(${g}, ${g}, ${g*.8}, 1)`,o.fillRect(u*c,d*c,c,c)}}function D(l){const t=new Float32Array(l.length);t.set(l,0);let s=-1/0,e=1/0;for(let i=0;i<t.length;i++)t[i]>s&&(s=t[i]),t[i]<e&&(e=t[i]);for(let i=0;i<t.length;i++)t[i]=(t[i]-e)/(s-e);return t}
