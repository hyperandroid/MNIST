import{G as p,K as I,T as $,M,a as B}from"./MNIST-BhAB_iSj.js";const h=20;class S{constructor(t,n,e=24,i=24,a=!1){this.onModelChanged=t,this.onModelCleared=n,this.rows=e,this.columns=i,this.showPadded=a,this.root=document.createElement("div"),document.getElementById("row").appendChild(this.root),this.canvas=document.createElement("canvas"),this.canvas.width=this.columns*h,this.canvas.height=this.rows*h,this.ctx=this.canvas.getContext("2d"),this.model=new Float32Array(e*i),this.outmodel=new Float32Array(784),this.render(this.ctx,this.rows,this.columns,this.model),this.canvas.addEventListener("mousedown",s=>{this.capturing=!0}),this.canvas.addEventListener("mouseup",s=>{this.capturing=!1}),this.canvas.addEventListener("mousemove",s=>{this.capturing&&this.setModel(s)}),this.canvas.addEventListener("click",s=>{this.setModel(s)}),this.root.appendChild(document.createTextNode(`${this.rows}x${this.columns}, padded to 28x28`)),this.root.appendChild(document.createElement("br")),this.root.appendChild(document.createElement("br")),this.root.appendChild(this.canvas),this.root.appendChild(document.createElement("br"));const o=document.createElement("button");o.textContent="Clear",o.addEventListener("click",()=>{this.model.fill(0),this.render(this.ctx,this.rows,this.columns,this.model),this.onModelCleared()}),this.root.appendChild(o),a&&(this.canvasOut=document.createElement("canvas"),this.canvasOut.width=28*h,this.canvasOut.height=28*h,this.ctxOut=this.canvasOut.getContext("2d"),this.root.appendChild(document.createElement("br")),this.root.appendChild(this.canvasOut),this.render(this.ctxOut,28,28,this.outmodel))}root;canvas;ctx;canvasOut;ctxOut;model;outmodel;capturing=!1;incColor(t,n,e=1){n>0&&this.increment(t,n-1,.33*e),n<this.rows-1&&this.increment(t,n+1,.33*e),t>0&&this.increment(t-1,n,.33*e),t<this.columns-1&&this.increment(t+1,n,.33*e),this.increment(t,n,e)}increment(t,n,e){const i=this.model[n*this.columns+t];this.model[n*this.columns+t]=Math.max(0,Math.min(1,i+e))}setModel(t){const n=Math.floor(t.offsetX/h),e=Math.floor(t.offsetY/h);t.altKey?this.incColor(n,e,-1):this.incColor(n,e),this.render(this.ctx,this.rows,this.columns,this.model),this.process(),this.showPadded&&this.render(this.ctxOut,28,28,this.outmodel),this.onModelChanged(this.outmodel)}process(){this.outmodel.fill(0);let t=1/0,n=-1/0,e=1/0,i=-1/0;for(let o=0;o<this.rows;o++)for(let s=0;s<this.columns;s++)this.model[o*this.columns+s]>0&&(o<t&&(t=o),o>n&&(n=o),s<e&&(e=s),s>i&&(i=s));const a=Math.floor((28-(i-e))/2),r=Math.floor((28-(n-t))/2);for(let o=0;o<=n-t;o++)for(let s=0;s<=i-e;s++)this.outmodel[(o+r)*28+s+a]=this.model[(o+t)*this.columns+s+e]}render(t,n,e,i){t.fillStyle="#111",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.strokeStyle="white";for(let a=0;a<n;a++)for(let r=0;r<e;r++){const o=i[a*e+r],s=Math.floor(o*255);t.fillStyle=`rgba(${s},${s},${s*.7},1.0)`,t.fillRect(r*h,a*h,h,h),t.strokeRect(r*h,a*h,h,h)}}}class T{ctx;constructor(){const t=document.createElement("canvas");t.width=2*784+20,t.height=280,this.ctx=t.getContext("2d"),this.ctx.font="20px Arial",this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),(document.getElementById("layers")??document.body).appendChild(t)}render(t,n){this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),t.forEach((e,i)=>{this.drawLayer(e,10,10+i*65,n[i],i>0)})}drawLayer(t,n,e,i,a=!1){let r=-1/0,o=1/0;for(let c=0;c<t.length;c++)t[c]>r&&(r=t[c]),t[c]<o&&(o=t[c]);for(let c=0;c<t.length;c++)t[c]=(t[c]-o)/(r-o);const s=784/t.length*2;for(let c=0;c<t.length;c++){const m=t[c],d=Math.floor(m*255);this.ctx.fillStyle=`rgb(${d},${d},${d*.8})`,this.ctx.fillRect(n+c*s,e+30,s,20),a&&(this.ctx.strokeStyle="white",this.ctx.strokeRect(n+c*s,e+30,s,20))}this.ctx.fillStyle="White",this.ctx.fillText(i,n,e+20)}}await p.init();const f=new $(p.device),x=new I(p.device,f),u=new M(f,x),L=await u.readSnapshot();k(L);const O=new B;await O.load("data/mnist").catch(l=>{throw new Error("Failed to load data source: "+l)});const P=new Float32Array(10);let y=!1;new S(async l=>{await p.device.queue.onSubmittedWorkDone(),!y&&(y=!0,await R(l),y=!1)},async()=>{C(P),b.render([],[])});const b=new T;(function(){const l=document.getElementById("row"),t=document.createElement("span");t.style.display="inline-flex",t.style.flexDirection="column",t.style.gap="6px";let n=0;Array.from({length:10},()=>{const e=document.createElement("span");e.classList.add("probability"),e.id=`probability-${n}`;const i=document.createElement("input");i.style.pointerEvents="none",i.type="range",i.min="0",i.max="100",i.value="0",i.id=`probability-slider-${n}`,e.appendChild(i),e.appendChild(document.createTextNode(`${n}`));const a=document.createElement("span");return a.id=`probability-percentage-${n}`,e.appendChild(a),t.appendChild(e),n++,i}),l.appendChild(t)})();async function R(l){const t=f.getTensorBuffer("test_input",GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST,[1,l.length],l);f.beginScope("test");const n=u.model.forward(t,!1),e=x.softmax.run(n),i=await f.readBuffer(e.buffer,e.sizeInBytes());C(i);const a=[];for(const o of u.model.layers){const s=o.inputTensor,c=await f.readBuffer(s.buffer,s.sizeInBytes());a.push(c)}a.push(i);const r=u.model.layers.map(o=>`${o.name} [${o.inputTensor?.shape}]`);r.push("Predictions. Shape [1,10]. Digit 0..9"),b.render(a,r)}function C(l){let t=-1/0,n=0;for(let e=0;e<10;e++){const i=l[e];i>t&&(t=i,n=e);const a=document.getElementById(`probability-${e}`);a!==null&&(a.style.backgroundColor="default");const r=document.getElementById(`probability-slider-${e}`);r!==null&&(r.value=(100*i).toFixed(2));const o=(i*100).toFixed(2),s=document.getElementById(`probability-percentage-${e}`);s!==null&&(s.innerHTML=`${o}%`)}for(let e=0;e<10;e++){const i=document.getElementById(`probability-percentage-${e}`);i.style.backgroundColor=e===n&&l[n]>0?"green":"rgba(0,0,0,0)"}}function k(l){v(l[0],768,128,l[1],128,1,"First Layer. Dense [768->128]"),v(l[2],128,10,l[3],10,1,"Output Layer. Dense [128->10]")}function v(l,t,n,e,i,a,r){const o=document.getElementById("parameters-container"),s=document.createElement("div");s.className="parameter-images",o.appendChild(s);const c=document.createElement("h4");c.innerHTML=r,s.appendChild(c),w(s,l,t,n,"Weights"),w(s,e,i,a,"Bias")}function w(l,t,n,e,i){const a=document.createElement("canvas"),r=n<768?10:2;a.width=n*r,a.height=e*r;const o=a.getContext("2d"),s=document.createElement("div");s.className="parameter-image",s.appendChild(document.createTextNode(`${i}`)),s.appendChild(a),l.appendChild(s);const c=A(t);for(let m=0;m<e;m++)for(let d=0;d<n;d++){const E=m*n+d,g=Math.floor(c[E]*255);o.fillStyle=`rgba(${g}, ${g}, ${g*.8}, 1)`,o.fillRect(d*r,m*r,r,r)}}function A(l){const t=new Float32Array(l.length);t.set(l,0);let n=-1/0,e=1/0;for(let i=0;i<t.length;i++)t[i]>n&&(n=t[i]),t[i]<e&&(e=t[i]);for(let i=0;i<t.length;i++)t[i]=(t[i]-e)/(n-e);return t}
